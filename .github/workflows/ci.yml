name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  UV_VERSION: "0.7"
  PYTHON_VERSION: "3.12"

jobs:
  # ── Guardrails (always runs fully) ────────────────────
  guardrails:
    name: Workspace Guardrails
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pin guardrails from main
        if: github.event_name == 'pull_request'
        run: |
          git checkout origin/main -- scripts/ pyproject.toml .python-version

      - uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Check workspace conventions
        run: uv run python scripts/check_deps.py

      - name: Check lock file drift
        run: bash scripts/check_lock.sh

  # ── Lint (always runs fully) ──────────────────────────
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pin guardrails from main
        if: github.event_name == 'pull_request'
        run: |
          git checkout origin/main -- scripts/ pyproject.toml .python-version

      - uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}

      - name: Install dependencies
        run: |
          uv sync
          uv pip install -e libs/* -e apps/*

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

      - name: Import boundary check
        run: uv run lint-imports

      - name: Type check (ty)
        run: uv run ty check

  # ── Detect Changes ────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      test_paths: ${{ steps.detect.outputs.test_paths }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}

      - name: Install dependencies
        run: |
          uv sync
          uv pip install -e libs/* -e apps/*

      - name: Detect changed packages
        id: detect
        run: |
          result=$(uv run python scripts/detect_changes.py --base origin/main)
          echo "$result"
          test_paths=$(echo "$result" | jq -r '.test_paths | join(" ")')
          has_changes=$( [ -n "$test_paths" ] && echo "true" || echo "false" )
          echo "test_paths=$test_paths" >> "$GITHUB_OUTPUT"
          echo "has_changes=$has_changes" >> "$GITHUB_OUTPUT"

  # ── Tests (selective on PRs, full on main) ────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [changes]
    if: always() && (needs.changes.result == 'skipped' || needs.changes.outputs.has_changes == 'true')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pin guardrails from main
        if: github.event_name == 'pull_request'
        run: |
          git checkout origin/main -- scripts/ pyproject.toml .python-version

      - uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}

      - name: Install dependencies
        run: |
          uv sync
          uv pip install -e libs/* -e apps/*

      - name: Run tests (selective)
        if: github.event_name == 'pull_request' && needs.changes.outputs.test_paths != ''
        run: |
          uv run pytest ${{ needs.changes.outputs.test_paths }} --cov --cov-report=term-missing

      - name: Run tests (full)
        if: github.event_name == 'push'
        run: |
          uv run pytest --cov --cov-report=term-missing
